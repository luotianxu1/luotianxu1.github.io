---
title: ç›®å½•ç»“æ„
icon: nginx
order: 2
date: 2024-06-06
category:
    - Nginx
tag:
    - Nginx
---

## ç›®å½•ç»“æ„

```bash
[root@localhost ~]# tree /usr/local/nginx
/usr/local/nginx
â”œâ”€â”€ client_body_temp                 # POST å¤§æ–‡ä»¶æš‚å­˜ç›®å½•
â”œâ”€â”€ conf                             # Nginxæ‰€æœ‰é…ç½®æ–‡ä»¶çš„ç›®å½•
â”‚   â”œâ”€â”€ fastcgi.conf                 # fastcgiç›¸å…³å‚æ•°çš„é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ fastcgi.conf.default         # fastcgi.confçš„åŸå§‹å¤‡ä»½æ–‡ä»¶
â”‚   â”œâ”€â”€ fastcgi_params               # fastcgiçš„å‚æ•°æ–‡ä»¶
â”‚   â”œâ”€â”€ fastcgi_params.default
â”‚   â”œâ”€â”€ koi-utf
â”‚   â”œâ”€â”€ koi-win
â”‚   â”œâ”€â”€ mime.types                   # åª’ä½“ç±»å‹
â”‚   â”œâ”€â”€ mime.types.default
â”‚   â”œâ”€â”€ nginx.conf                   #è¿™æ˜¯Nginxé»˜è®¤çš„ä¸»é…ç½®æ–‡ä»¶ï¼Œæ—¥å¸¸ä½¿ç”¨å’Œä¿®æ”¹çš„æ–‡ä»¶
â”‚   â”œâ”€â”€ nginx.conf.default
â”‚   â”œâ”€â”€ scgi_params                  # scgiç›¸å…³å‚æ•°æ–‡ä»¶
â”‚   â”œâ”€â”€ scgi_params.default
â”‚   â”œâ”€â”€ uwsgi_params                 # uwsgiç›¸å…³å‚æ•°æ–‡ä»¶
â”‚   â”œâ”€â”€ uwsgi_params.default
â”‚   â””â”€â”€ win-utf
â”œâ”€â”€ fastcgi_temp                     # fastcgiä¸´æ—¶æ•°æ®ç›®å½•
â”œâ”€â”€ html                             # Nginxé»˜è®¤ç«™ç‚¹ç›®å½•
â”‚   â”œâ”€â”€ 50x.html                     # é”™è¯¯é¡µé¢ä¼˜é›…æ›¿ä»£æ˜¾ç¤ºæ–‡ä»¶ï¼Œä¾‹å¦‚å‡ºç°502é”™è¯¯æ—¶ä¼šè°ƒç”¨æ­¤é¡µé¢
â”‚   â””â”€â”€ index.html                   # é»˜è®¤çš„é¦–é¡µæ–‡ä»¶
â”œâ”€â”€ logs                             # Nginxæ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ access.log                   # è®¿é—®æ—¥å¿—æ–‡ä»¶
â”‚   â”œâ”€â”€ error.log                    # é”™è¯¯æ—¥å¿—æ–‡ä»¶
â”‚   â””â”€â”€ nginx.pid                    # pidæ–‡ä»¶ï¼ŒNginxè¿›ç¨‹å¯åŠ¨åï¼Œä¼šæŠŠæ‰€æœ‰è¿›ç¨‹çš„IDå·å†™åˆ°æ­¤æ–‡ä»¶
â”œâ”€â”€ proxy_temp                       # ä¸´æ—¶ç›®å½•
â”œâ”€â”€ sbin                             # Nginx å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ nginx                        # Nginx äºŒè¿›åˆ¶å¯æ‰§è¡Œç¨‹åº
â”œâ”€â”€ scgi_temp                        # ä¸´æ—¶ç›®å½•
â””â”€â”€ uwsgi_temp                       # ä¸´æ—¶ç›®å½•
```

## åŸºæœ¬é…ç½®æ–‡ä»¶

### é»˜è®¤æ–‡ä»¶

```bash
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            root   html;
            index  index.html index.htm;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }


    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}
```

### æ³¨é‡Š

```bash
# æ›´å¤šé…ç½®ä¿¡æ¯ http://nginx.org/en/docs/
user nginx;

# å·¥ä½œè¿›ç¨‹ï¼šä¸€èˆ¬æ˜¯ cpuæœ‰å‡ æ ¸å°±å†™å‡ ï¼Œå¯ä»¥æœ€å¤§é™åº¦çš„å»å‘æŒ¥å®ƒçš„æ€§èƒ½
worker_processes auto;

# é”™è¯¯æ—¥å¿—è·¯å¾„
error_log /var/log/nginx/error.log;

# åƒä¸‡åˆ«åŠ¨è¿™ç©æ„ï¼Œæ˜¯ç»™å®ˆæŠ¤è¿›ç¨‹ç”¨çš„
pid /var/run/nginx.pid;

# è´Ÿè½½åŠ¨æ€æ¨¡å—
include /usr/share/nginx/modules/*.conf

# å¹¶å‘è¿æ¥æ•°ï¼šæœ€å¤§å¹¶å‘æ•° -> ä¸€ä¸ªå·¥ä½œè¿›ç¨‹ä¸‹çš„æœ€å¤§è¿æ¥ã€é»˜è®¤ 1024ã€‘
events {
    worker_connections 1024;
}

# http é…ç½®
http {
    # æ—¥å¿—æ ¼å¼
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    # è®¿é—®æ—¥å¿—çš„è·¯å¾„
    access_log          /var/log/nginx/access.log  main;

    # sendfile & tcp_nopush & tcp_nodelayçš„è§£é‡Š https://www.jianshu.com/p/cac0a92b9530
    # æ˜¯å¦å…è®¸ä¸Šä¼ æ–‡ä»¶
    sendfile            on;

    # å…è®¸æŠŠhttp response headerå’Œæ–‡ä»¶çš„å¼€å§‹æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œå‘å¸ƒï¼Œä½œç”¨æ˜¯å‡å°‘ç½‘ç»œæŠ¥æ–‡æ®µçš„æ•°é‡
    tcp_nopush          on;

    # å†…æ ¸ä¼šç­‰å¾…å°†æ›´å¤šçš„å­—èŠ‚ç»„æˆä¸€ä¸ªæ•°æ®åŒ…ï¼Œä»è€Œæé«˜I/Oæ€§èƒ½
    tcp_nodelay         on;

    # gzip å‹ç¼©
    gzip                on;

    # é•¿è¿æ¥å¤šé•¿æ—¶é—´æ²¡æœ‰é€šä¿¡è‡ªåŠ¨æ–­å¼€
    keepalive_timeout   65;

    # ä¸ºäº†å¿«é€Ÿå¤„ç†é™æ€æ•°æ®é›†ï¼Œä¾‹å¦‚æœåŠ¡å™¨åç§°ï¼Œ æ˜ å°„æŒ‡ä»¤çš„å€¼ï¼ŒMIMEç±»å‹ï¼Œè¯·æ±‚å¤´å­—ç¬¦ä¸²çš„åç§°ï¼Œnginxä½¿ç”¨å“ˆå¸Œè¡¨
    types_hash_max_size 2048;

    # æ–‡ä»¶æ‰©å±•åä¸ç±»å‹æ˜ å°„è¡¨
    include             /etc/nginx/mime.types;

    # é»˜è®¤æ–‡ä»¶ç±»å‹
    default_type        application/octet-stream;

    # å®šä¹‰åå‘ä»£ç†æœåŠ¡å™¨
    upstream web{
        # è®¾ç½®åï¼Œåé¢æ¯æ¬¡è®¿é—®éƒ½æ˜¯å®šä½åˆ°ç¬¬ä¸€æ¬¡è®¿é—®åˆ°çš„æœåŠ¡å™¨
        ip_hash;

        # è¿™é‡Œçš„ serverå¦‚æœåªå†™ä¸€ä¸ªå°±æ˜¯å•çº¯çš„é¢å¤–ç½‘å‘å¸ƒ,å¦‚æœå†™ n ä¸ªå°±æ˜¯è´Ÿè½½å‡è¡¡
        server 127.0.0.1:8080;
        server 127.0.0.1:8888 weight=1; #æ·»åŠ æƒé‡
    }

    #-------------------------------------------------------------------------
    # åŠ è½½æ¨¡å—åŒ–é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥æŠŠä¸‹é¢ serverçš„é…ç½®å†™åˆ° /etc/nginx/conf.d/ è·¯å¾„ä¸‹çš„æŸä¸ªæ–‡ä»¶ğŸ‘‡
    # ğŸ‘† å°±å¯ä»¥ç›´æ¥å¼•å…¥ï¼Œä¸éœ€è¦åœ¨è¿™ä¸ªæ–‡ä»¶å†™serverçš„é…ç½®
    include                       /etc/nginx/conf.d/*.conf;
    #-------------------------------------------------------------------------

    # ä¸€ä¸ª serverå¯¹åº”ä¸€ä¸ªç½‘ç«™
    server {
        # ç›‘å¬ç«¯å£
        listen       80 default_server;
        listen       [::]:80 default_server;

        # serveråŸŸå
        server_name  localhost;

        # ç«™ç‚¹æ ¹ç›®å½•ï¼Œå³ç½‘ç«™ç¨‹åºå­˜æ”¾ç›®å½•
        root         /usr/share/nginx/html;

        # é»˜è®¤æœåŠ¡å™¨å—çš„åŠ è½½é…ç½®æ–‡ä»¶
        include      /etc/nginx/default.d/*.conf;

        # å¯¹â€œ/â€å¯ç”¨åå‘ä»£ç†
        location / {
            root     html;
            index    index.html  index.htm;
        }

        # å¯¹â€œ/xxx/â€å¯ç”¨åå‘ä»£ç†
        location /xxx/ {
            # è¿‡æ¥çš„è¯·æ±‚ä»£ç†åˆ°å“ªé‡Œï¼Œwebä¸ºå‰é¢upstreamå®šä¹‰çš„
            proxy_pass http://web;

            # å¦‚æœéœ€è¦å®¢æˆ·ç«¯ ip,è¿™ä¸ªå¼€å…³å¯èƒ½ä¼šé‡å†™ä¸ºåå‘ä»£ç†çš„ ip
            proxy_redirect off;

            # nginx å¯èƒ½ä¼šæ”¹å†™å¤´,ç”¨åŸæ¥çš„å€¼å†æŠŠå®ƒæ”¹å›æ¥
            proxy_set_header Hose $host;

            # ä»£ç†æœåŠ¡å™¨è½¬å‘è¯·æ±‚çš„æ—¶å€™ç”¨çš„åè®®ç‰ˆæœ¬
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_cache_bypass $http_upgrade;

            # å–å®¢æˆ·ç«¯çœŸå® ip
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # è¶…æ—¶
            proxy_connect_timeout 600;
            proxy_read_timeout 600;
        }

        error_page 404 /404.html;

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }

    # é…ç½® https
    server {
        # ä¸€å®šè¦å¸¦ä¸Š ssl æ ‡è®°,é»˜è®¤ 443 ç«¯å£
        listen       443 ssl;
        server_name  work.com;
        ssl                  on;

        # è¯ä¹¦
        ssl_certificate      /etc/nginx/server.crt;

        # å¯†é’¥
        ssl_certificate_key  /etc/nginx/server.key;

        # è¶…æ—¶
        ssl_session_timeout  5m;

        location / {
            root   /usr/local/web/;
            add_header 'Cache-Control' 'no-store';
        }
    }
}
```
